# 🔍 VÍ DỤ CỤ THỂ: DỰ ĐOÁN 1 ẢNH

---

## 📸 INPUT: 1 Ảnh Vệ Tinh

```
Tên file: Sentinel2_HCMC_20231225.tif
Khu vực: TP. Hồ Chí Minh
Ngày chụp: 25/12/2023
Định dạng: TIFF (3 kênh: B11, B8, B4)
Kích thước gốc: 512 × 512 pixels
```

---

## 🔄 QUÁ TRÌNH DỰ ĐOÁN TỪNG BƯỚC

### BƯỚC 1: Đọc file ảnh

```python
# Code thực tế trong predict.py
img = Image.open("Sentinel2_HCMC_20231225.tif").convert('RGB')
```

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                            ẢNH GỐC (512×512)                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   Kênh B11 (SWIR)          Kênh B8 (NIR)           Kênh B4 (Red)           │
│   ┌───────────────┐        ┌───────────────┐       ┌───────────────┐       │
│   │▓▓▓▓▓░░░░░░░░░│        │▓▓▓░░░░░░░░░░░│       │▓▓░░░░░░░░░░░░│       │
│   │▓▓▓▓▓▓░░░░░░░░│        │▓▓▓▓░░░░░░░░░░│       │▓▓▓░░░░░░░░░░░│       │
│   │▓▓▓▓▓▓▓░░░░░░░│        │▓▓▓▓▓░░░░░░░░░│       │▓▓▓▓░░░░░░░░░░│       │
│   │░▓▓▓▓▓▓▓░░░░░░│        │░▓▓▓▓▓░░░░░░░░│       │░▓▓▓▓░░░░░░░░░│       │
│   │░░░▓▓▓▓▓▓░░░░░│        │░░░▓▓▓▓░░░░░░░│       │░░░▓▓▓░░░░░░░░│       │
│   │░░░░░▓▓▓▓░░░░░│        │░░░░░▓▓░░░░░░░│       │░░░░░▓▓░░░░░░░│       │
│   └───────────────┘        └───────────────┘       └───────────────┘       │
│                                                                             │
│   Giá trị pixel mẫu (góc trên trái):                                       │
│   B11: 180 (tín hiệu SWIR cao = nhiều hơi nước)                            │
│   B8:  120 (tín hiệu NIR trung bình)                                       │
│   B4:  90  (tín hiệu Red thấp)                                             │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

### BƯỚC 2: Tiền xử lý (Transform)

```python
# Code thực tế
transform = transforms.Compose([
    transforms.Resize((224, 224)),
    transforms.ToTensor(),
    transforms.Normalize([0.485, 0.456, 0.406], [0.229, 0.224, 0.225])
])

img_tensor = transform(img).unsqueeze(0)  # Thêm batch dimension
```

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         TIỀN XỬ LÝ ẢNH                                      │
└─────────────────────────────────────────────────────────────────────────────┘

    ẢNH GỐC                    RESIZE                      NORMALIZE
    512×512                    224×224                     224×224
    ┌─────────────┐           ┌─────────┐                 ┌─────────┐
    │░▓▓▓▓▓░░░░░░│           │░▓▓░░░░░│                 │-0.5 0.2│
    │░▓▓▓▓▓▓░░░░░│   ───►    │░▓▓▓░░░░│      ───►       │-0.3 0.5│
    │░░▓▓▓▓▓▓░░░░│           │░░▓▓░░░░│                 │-0.1 0.3│
    │░░░░▓▓▓▓░░░░│           │░░░▓░░░░│                 │ 0.1 0.4│
    │            │           │        │                 │        │
    └─────────────┘           └─────────┘                 └─────────┘
    
    Giá trị pixel trước:      Sau Resize:                 Sau Normalize:
    [180, 120, 90]            [180, 120, 90]              [0.706→0.97, ...]
                              (giữ tỷ lệ)                  ↓
                                                          (x - mean) / std
    
    ┌─────────────────────────────────────────────────────────────────────────┐
    │ CÔNG THỨC NORMALIZE:                                                    │
    │                                                                         │
    │   pixel_normalized = (pixel / 255.0 - mean) / std                      │
    │                                                                         │
    │   Ví dụ với B11 = 180:                                                 │
    │   = (180/255 - 0.485) / 0.229                                          │
    │   = (0.706 - 0.485) / 0.229                                            │
    │   = 0.221 / 0.229                                                      │
    │   = 0.97                                                               │
    └─────────────────────────────────────────────────────────────────────────┘
    
    OUTPUT:
    ┌───────────────────────────────────────────────────────────────────────┐
    │  img_tensor.shape = [1, 3, 224, 224]                                  │
    │                      ↑  ↑   ↑    ↑                                    │
    │                  batch │ height width                                 │
    │                     channels                                          │
    └───────────────────────────────────────────────────────────────────────┘
```

---

### BƯỚC 3: Đưa qua Model ResNet34

```python
# Code thực tế
with torch.no_grad():
    outputs = model(img_tensor)
```

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    FORWARD PASS QUA RESNET34                                │
└─────────────────────────────────────────────────────────────────────────────┘

    Input Tensor [1, 3, 224, 224]
                 │
    ═════════════╪═════════════════════════════════════════════════════════
                 │              CONV1 (kernel 7×7)
                 ▼
    ┌─────────────────────────────────────────────────────────────────────┐
    │  Phát hiện CẠNH và GRADIENT                                         │
    │                                                                     │
    │  ┌────────────┐      ┌─────────────┐      ┌─────────────┐          │
    │  │ Cạnh ngang │      │ Cạnh dọc    │      │ Gradient    │          │
    │  │ ════════   │      │ ║║║║║║║║    │      │   ░▒▓█      │          │
    │  │ ════════   │      │ ║║║║║║║║    │      │  ░▒▓█       │          │
    │  └────────────┘      └─────────────┘      └─────────────┘          │
    │                                                                     │
    │  → 64 feature maps, kích thước 112×112                             │
    └─────────────────────────────────────────────────────────────────────┘
                 │
    ═════════════╪═════════════════════════════════════════════════════════
                 │              LAYER 1 (3 blocks)
                 ▼
    ┌─────────────────────────────────────────────────────────────────────┐
    │  Phát hiện TEXTURE cơ bản                                           │
    │                                                                     │
    │  ┌────────────┐      ┌─────────────┐      ┌─────────────┐          │
    │  │ Vùng mịn   │      │ Vùng sần sùi│      │ Vùng đốm    │          │
    │  │ ░░░░░░░░   │      │ ▓░▓░▓░▓░    │      │ ●  ●   ●   │          │
    │  │ ░░░░░░░░   │      │ ░▓░▓░▓░▓    │      │   ●   ●    │          │
    │  └────────────┘      └─────────────┘      └─────────────┘          │
    │                                                                     │
    │  → 64 feature maps, kích thước 56×56                               │
    └─────────────────────────────────────────────────────────────────────┘
                 │
    ═════════════╪═════════════════════════════════════════════════════════
                 │              LAYER 2 (4 blocks)
                 ▼
    ┌─────────────────────────────────────────────────────────────────────┐
    │  Phát hiện HÌNH DẠNG                                                │
    │                                                                     │
    │  ┌────────────┐      ┌─────────────┐      ┌─────────────┐          │
    │  │ Vùng tròn  │      │ Vùng dài    │      │ Vùng bất   │          │
    │  │   (●)      │      │ ═══════     │      │ định hình  │          │
    │  │            │      │             │      │    ~       │          │
    │  └────────────┘      └─────────────┘      └─────────────┘          │
    │                                                                     │
    │  → 128 feature maps, kích thước 28×28                              │
    └─────────────────────────────────────────────────────────────────────┘
                 │
    ═════════════╪═════════════════════════════════════════════════════════
                 │              LAYER 3 (6 blocks)
                 ▼
    ┌─────────────────────────────────────────────────────────────────────┐
    │  Phát hiện PATTERN MÂY                                              │
    │                                                                     │
    │  ┌────────────┐      ┌─────────────┐      ┌─────────────┐          │
    │  │ Mây ti     │      │ Mây tích    │      │ Mây vũ tích │◄── ĐÂY! │
    │  │ (mỏng)     │      │ (dày)       │      │ (mưa lớn)   │          │
    │  │ ═══════    │      │ ▓▓▓▓▓▓▓▓    │      │ █████████   │          │
    │  └────────────┘      └─────────────┘      └─────────────┘          │
    │                                                                     │
    │  → 256 feature maps, kích thước 14×14                              │
    └─────────────────────────────────────────────────────────────────────┘
                 │
    ═════════════╪═════════════════════════════════════════════════════════
                 │              LAYER 4 (3 blocks)
                 ▼
    ┌─────────────────────────────────────────────────────────────────────┐
    │  Phát hiện ĐẶC TRƯNG CAO CẤP                                        │
    │                                                                     │
    │  Feature maps chứa thông tin tổng hợp:                              │
    │  ┌─────────────────────────────────────────────────────────────┐    │
    │  │ • Mật độ mây trên toàn ảnh: CAO (85%)                       │    │
    │  │ • Độ dày trung bình mây: DÀY                                │    │
    │  │ • Pattern giống mây vũ tích: MẠNH                           │    │
    │  │ • Tín hiệu SWIR: CAO (nhiều hơi nước)                       │    │
    │  │ • Độ đồng nhất: TRUNG BÌNH (có vùng sáng tối xen kẽ)        │    │
    │  └─────────────────────────────────────────────────────────────┘    │
    │                                                                     │
    │  → 512 feature maps, kích thước 7×7                                │
    └─────────────────────────────────────────────────────────────────────┘
                 │
    ═════════════╪═════════════════════════════════════════════════════════
                 │              AVERAGE POOLING
                 ▼
    ┌─────────────────────────────────────────────────────────────────────┐
    │  Tính TRUNG BÌNH mỗi feature map                                    │
    │                                                                     │
    │  Feature map 1 (7×7):       Feature map 2 (7×7):                   │
    │  ┌─────────────┐            ┌─────────────┐                        │
    │  │0.3 0.5 0.4..│            │0.8 0.9 0.7..│                        │
    │  │0.6 0.7 0.5..│ → avg=0.52 │0.6 0.8 0.9..│ → avg=0.81             │
    │  │...         │            │...         │                        │
    │  └─────────────┘            └─────────────┘                        │
    │                                                                     │
    │  → 512 giá trị trung bình (feature vector)                         │
    │  [0.52, 0.81, 0.34, 0.77, ..., 0.65]                               │
    └─────────────────────────────────────────────────────────────────────┘
                 │
    ═════════════╪═════════════════════════════════════════════════════════
                 │              DROPOUT (p=0.6)
                 ▼
    ┌─────────────────────────────────────────────────────────────────────┐
    │  Tắt ngẫu nhiên 60% neurons (chỉ khi training)                      │
    │                                                                     │
    │  Training:    [0.52, X, 0.34, X, X, 0.21, ...]  (X = tắt)          │
    │  Inference:   [0.52, 0.81, 0.34, 0.77, ...]    (giữ nguyên)        │
    │                                                                     │
    └─────────────────────────────────────────────────────────────────────┘
                 │
    ═════════════╪═════════════════════════════════════════════════════════
                 │              FULLY CONNECTED (512 → 3)
                 ▼
    ┌─────────────────────────────────────────────────────────────────────┐
    │  Nhân ma trận để ra 3 LOGITS                                        │
    │                                                                     │
    │  512 features           Weight Matrix          3 Logits            │
    │  ┌─────────┐           ┌─────────────┐        ┌─────────┐          │
    │  │  0.52   │           │ w₁₁ w₁₂ w₁₃│        │  -2.5   │ not_rain │
    │  │  0.81   │     ×     │ w₂₁ w₂₂ w₂₃│   =    │   1.2   │ medium   │
    │  │  0.34   │           │ ... ... ...│        │   0.3   │ heavy    │
    │  │  ...    │           │w₅₁₂ ...    │        └─────────┘          │
    │  │  0.65   │           └─────────────┘                             │
    │  └─────────┘           (512×3 weights)                             │
    │                                                                     │
    │  Công thức: logit_i = Σ(feature_j × weight_ji) + bias_i            │
    └─────────────────────────────────────────────────────────────────────┘
                 │
    ═════════════╪═════════════════════════════════════════════════════════
                 │
                 ▼
    OUTPUT: logits = [-2.5, 1.2, 0.3]
```

---

### BƯỚC 4: Tính xác suất (Softmax)

```python
# Code thực tế
probs = torch.softmax(outputs, dim=1)
```

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         SOFTMAX CALCULATION                                  │
└─────────────────────────────────────────────────────────────────────────────┘

    Logits (raw scores):
    ┌─────────────────────────────────────────────────────────────────────────┐
    │  not_rain:  -2.5  (model KHÔNG nghĩ đây là không mưa)                  │
    │  medium:     1.2  (model nghĩ đây CÓ THỂ là mưa vừa) ◄─── Cao nhất!   │
    │  heavy:      0.3  (model nghĩ có khả năng mưa nặng)                    │
    └─────────────────────────────────────────────────────────────────────────┘

    ╔═══════════════════════════════════════════════════════════════════════╗
    ║  CÔNG THỨC SOFTMAX:                                                   ║
    ║                                                                       ║
    ║                    e^(logit_i)                                        ║
    ║  P(class_i) = ─────────────────────                                   ║
    ║               e^(logit_0) + e^(logit_1) + e^(logit_2)                ║
    ╚═══════════════════════════════════════════════════════════════════════╝

    TÍNH TOÁN CHI TIẾT:
    ┌─────────────────────────────────────────────────────────────────────────┐
    │                                                                         │
    │  Bước 1: Tính e^(logit) cho mỗi class                                  │
    │  ────────────────────────────────────                                   │
    │  e^(-2.5) = 0.082                                                      │
    │  e^( 1.2) = 3.320                                                      │
    │  e^( 0.3) = 1.350                                                      │
    │                                                                         │
    │  Bước 2: Tính tổng                                                     │
    │  ────────────────                                                       │
    │  Tổng = 0.082 + 3.320 + 1.350 = 4.752                                 │
    │                                                                         │
    │  Bước 3: Tính xác suất từng class                                      │
    │  ───────────────────────────────                                        │
    │  P(not_rain) = 0.082 / 4.752 = 0.017 = 1.7%                           │
    │  P(medium)   = 3.320 / 4.752 = 0.699 = 69.9%  ◄─── CAO NHẤT!          │
    │  P(heavy)    = 1.350 / 4.752 = 0.284 = 28.4%                          │
    │                                                                         │
    │  Kiểm tra: 1.7% + 69.9% + 28.4% = 100% ✓                              │
    │                                                                         │
    └─────────────────────────────────────────────────────────────────────────┘

    OUTPUT: probs = [0.017, 0.699, 0.284]
                     ↓      ↓      ↓
                    1.7%  69.9%  28.4%
```

---

### BƯỚC 5: Lấy kết quả cuối cùng (Argmax)

```python
# Code thực tế
pred_class = torch.argmax(probs, dim=1).item()
class_names = ['not_rain', 'medium_rain', 'heavy_rain']
result = class_names[pred_class]
```

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         QUYẾT ĐỊNH CUỐI CÙNG                                │
└─────────────────────────────────────────────────────────────────────────────┘

    Probabilities:
    ┌─────────────────────────────────────────────────────────────────────────┐
    │                                                                         │
    │  Index 0 (not_rain):    ██░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░   1.7%        │
    │  Index 1 (medium):      █████████████████████████████████  69.9% ★     │
    │  Index 2 (heavy):       ████████████░░░░░░░░░░░░░░░░░░░░░  28.4%       │
    │                                                                         │
    └─────────────────────────────────────────────────────────────────────────┘

    ARGMAX:
    ┌─────────────────────────────────────────────────────────────────────────┐
    │                                                                         │
    │  argmax([0.017, 0.699, 0.284]) = 1                                     │
    │                   ↑                                                     │
    │              vị trí có giá trị lớn nhất                                │
    │                                                                         │
    │  class_names[1] = "medium_rain"                                        │
    │                                                                         │
    └─────────────────────────────────────────────────────────────────────────┘
```

---

## 📊 OUTPUT CUỐI CÙNG

```
╔═════════════════════════════════════════════════════════════════════════════╗
║                           KẾT QUẢ DỰ ĐOÁN                                   ║
╠═════════════════════════════════════════════════════════════════════════════╣
║                                                                             ║
║  📁 Input:  Sentinel2_HCMC_20231225.tif                                    ║
║                                                                             ║
║  🏷️  Label:  "medium_rain" (MƯA VỪA)                                       ║
║                                                                             ║
║  📊 Confidence: 69.9%                                                       ║
║                                                                             ║
║  📈 Phân bố xác suất:                                                       ║
║     ┌────────────────────────────────────────────────────────────────┐     ║
║     │ not_rain (Không mưa):   1.7%   ░░░░░░░░░░░░░░░░░░░░░░░░░░░░░  │     ║
║     │ medium_rain (Mưa vừa): 69.9%   █████████████████████████████  │     ║
║     │ heavy_rain (Mưa nặng): 28.4%   ████████████░░░░░░░░░░░░░░░░░  │     ║
║     └────────────────────────────────────────────────────────────────┘     ║
║                                                                             ║
╚═════════════════════════════════════════════════════════════════════════════╝
```

---

## 🧠 MODEL DỰA VÀO ĐÂU ĐỂ DỰ ĐOÁN?

### Các đặc trưng model "nhìn thấy" trong ảnh này:

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    PHÂN TÍCH ĐẶC TRƯNG ẢNH                                  │
└─────────────────────────────────────────────────────────────────────────────┘

    ┌─────────────────────────────────────────────────────────────────────────┐
    │  1. TÍN HIỆU SWIR (Band 11) - QUAN TRỌNG NHẤT                          │
    ├─────────────────────────────────────────────────────────────────────────┤
    │                                                                         │
    │  Giá trị SWIR trung bình: 180/255 = 0.71 (CAO)                        │
    │                                                                         │
    │  ├── SWIR thấp (< 0.3): Trời trong, không mây                         │
    │  ├── SWIR trung bình (0.3-0.6): Có mây, độ ẩm vừa                     │
    │  └── SWIR cao (> 0.6): Mây dày, nhiều hơi nước → CÓ MƯA ✓            │
    │                                                                         │
    │  Kết luận: Có hơi nước trong khí quyển → khả năng mưa                 │
    │                                                                         │
    └─────────────────────────────────────────────────────────────────────────┘

    ┌─────────────────────────────────────────────────────────────────────────┐
    │  2. MẬT ĐỘ MÂY (từ texture analysis)                                   │
    ├─────────────────────────────────────────────────────────────────────────┤
    │                                                                         │
    │  Diện tích mây phủ: ~75% ảnh                                           │
    │                                                                         │
    │  ┌─────────────────────────────────────────────────────────────────┐   │
    │  │ ▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓░░░░░░ │                                        │   │
    │  │ ▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓░░░░░ │  75% mây (xám/tối)                     │   │
    │  │ ▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓░░░░ │  25% không mây (sáng)                  │   │
    │  │ ░░▓▓▓▓▓▓▓▓▓▓▓▓░░░░░░░ │                                        │   │
    │  └─────────────────────────────────────────────────────────────────┘   │
    │                                                                         │
    │  Kết luận: Mây phủ nhiều nhưng không toàn bộ → MƯA VỪA                │
    │                                                                         │
    └─────────────────────────────────────────────────────────────────────────┘

    ┌─────────────────────────────────────────────────────────────────────────┐
    │  3. ĐỘ DÀY MÂY (từ độ tối của pixel)                                   │
    ├─────────────────────────────────────────────────────────────────────────┤
    │                                                                         │
    │  Giá trị pixel trung bình vùng mây: 120/255 = 0.47 (TRUNG BÌNH)       │
    │                                                                         │
    │  ├── Pixel sáng (> 0.7): Mây mỏng, không mưa                          │
    │  ├── Pixel xám (0.3-0.7): Mây dày vừa → MƯA VỪA ✓                     │
    │  └── Pixel tối (< 0.3): Mây rất dày → mưa nặng                        │
    │                                                                         │
    │  Kết luận: Độ dày trung bình → mưa vừa                                │
    │                                                                         │
    └─────────────────────────────────────────────────────────────────────────┘

    ┌─────────────────────────────────────────────────────────────────────────┐
    │  4. PATTERN MÂY (từ edge detection)                                    │
    ├─────────────────────────────────────────────────────────────────────────┤
    │                                                                         │
    │  Layer 3-4 của ResNet phát hiện:                                       │
    │  ✓ Có ranh giới mây rõ ràng                                            │
    │  ✓ Không phải mây đồng nhất (mưa nặng thường đồng nhất)               │
    │  ✓ Pattern giống mây tầng tích (stratocumulus)                        │
    │                                                                         │
    │  Kết luận: Pattern phù hợp với mưa vừa                                │
    │                                                                         │
    └─────────────────────────────────────────────────────────────────────────┘
```

---

## 📋 TÓM TẮT CHO THUYẾT TRÌNH

| Bước | Input | Output | Ý nghĩa |
|------|-------|--------|---------|
| **1. Đọc ảnh** | File .tif | Array 512×512×3 | 3 kênh B11, B8, B4 |
| **2. Tiền xử lý** | 512×512 | Tensor 1×3×224×224 | Chuẩn hóa cho model |
| **3. ResNet34** | 1×3×224×224 | 512 features | Trích xuất đặc trưng |
| **4. FC Layer** | 512 features | 3 logits | Điểm cho mỗi class |
| **5. Softmax** | [-2.5, 1.2, 0.3] | [0.017, 0.699, 0.284] | Chuyển thành xác suất |
| **6. Argmax** | [0.017, 0.699, 0.284] | 1 (medium_rain) | Chọn class cao nhất |

### Căn cứ dự đoán:
1. **SWIR cao** → Nhiều hơi nước → Có mưa
2. **Mây phủ 75%** → Không toàn bộ → Không phải mưa nặng
3. **Độ tối trung bình** → Mây dày vừa → Mưa vừa
4. **Pattern mây** → Giống mây tầng tích → Mưa vừa

### Kết quả:
- **Label**: medium_rain (Mưa vừa)
- **Confidence**: 69.9%

---

**📝 Tài liệu này giải thích chi tiết quá trình dự đoán 1 ảnh từ đầu đến cuối.**
