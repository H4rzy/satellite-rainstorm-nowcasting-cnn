<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dữ liệu Mưa Lịch sử - Atmospheric Lab</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/rainfall.css') }}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
    <div class="container">
        
        <nav class="nav-bar">
            <a href="{{ url_for('main.predict') }}" class="nav-brand">
                <i class="bi bi-cloud-drizzle icon"></i>
                <span>Atmospheric Lab</span>
            </a>
            <ul class="nav-links">
                <li><a href="{{ url_for('main.predict') }}" class="nav-link">Dự đoán</a></li>
                <li><a href="{{ url_for('main.rainfall_data') }}" class="nav-link active">Dữ liệu</a></li>
            </ul>
        </nav>

        
        <div class="page-header">
            <h1 class="page-title">
                <i class="bi bi-database"></i>
                Dữ liệu Mưa Lịch sử
            </h1>
            <p class="page-subtitle">Tra cứu và phân tích dữ liệu lượng mưa theo năm</p>
        </div>

        
        <div class="card selector-card">
            <div class="card-header">
                <i class="bi bi-calendar-check icon"></i>
                <h2 class="card-title">Chọn năm tra cứu</h2>
            </div>

            <form method="POST">
                <div class="form-group">
                    <label for="year" class="form-label">Năm</label>
                    <select name="year" id="year" class="form-select" required>
                        <option value="">-- Chọn năm --</option>
                        {% for y in years %}
                            <option value="{{ y }}" {% if selected_year and selected_year|int == y %}selected{% endif %}>
                                {{ y }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <button type="submit" class="btn btn-primary btn-full">
                    <i class="bi bi-search"></i>
                    <span>Xem dữ liệu</span>
                </button>
            </form>
        </div>

        {% if year_data is not none %}
            
            <div class="stats-grid">
                <div class="stat-card" style="animation: fadeInUp 0.6s var(--transition-smooth); animation-delay: 0.1s; animation-fill-mode: both;">
                    <div class="stat-value">{{ year_data|length }}</div>
                    <div class="stat-label">Số bản ghi</div>
                </div>
                <div class="stat-card" style="animation: fadeInUp 0.6s var(--transition-smooth); animation-delay: 0.2s; animation-fill-mode: both;">
                    <div class="stat-value">{{ "%.1f"|format(year_data['rainfall'].sum()) }}</div>
                    <div class="stat-label">Tổng lượng mưa (mm)</div>
                </div>
                <div class="stat-card" style="animation: fadeInUp 0.6s var(--transition-smooth); animation-delay: 0.3s; animation-fill-mode: both;">
                    <div class="stat-value">{{ "%.1f"|format(year_data['rainfall'].mean()) }}</div>
                    <div class="stat-label">Trung bình (mm)</div>
                </div>
                <div class="stat-card" style="animation: fadeInUp 0.6s var(--transition-smooth); animation-delay: 0.4s; animation-fill-mode: both;">
                    <div class="stat-value">{{ "%.1f"|format(year_data['rainfall'].max()) }}</div>
                    <div class="stat-label">Cao nhất (mm)</div>
                </div>
            </div>

            
            <div class="card" style="animation: fadeInUp 0.8s var(--transition-smooth); animation-delay: 0.5s; animation-fill-mode: both;">
                <div class="chart-header">
                    <h3 class="chart-title">
                        <i class="bi bi-graph-up"></i>
                        Biểu đồ lượng mưa năm {{ selected_year }}
                    </h3>
                </div>
                <div class="chart-container">
                    <canvas id="rainfallChart"></canvas>
                </div>
            </div>

            
            <div class="card" style="animation: fadeInUp 0.8s var(--transition-smooth); animation-delay: 0.6s; animation-fill-mode: both;">
                <div class="card-header">
                    <i class="bi bi-table icon"></i>
                    <h2 class="card-title">Chi tiết dữ liệu năm {{ selected_year }}</h2>
                </div>

                <div class="data-table-container">
                    {% if year_data.empty %}
                        <div class="table-empty">
                            <div class="icon"><i class="bi bi-inbox"></i></div>
                            <p>Không có dữ liệu cho năm {{ selected_year }}</p>
                        </div>
                    {% else %}
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>STT</th>
                                    <th>Ngày</th>
                                    <th>Lượng mưa (mm)</th>
                                    <th>Trực quan</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for row in year_data.itertuples() %}
                                <tr>
                                    <td>{{ loop.index }}</td>
                                    <td>{{ row.date.strftime("%d/%m/%Y") }}</td>
                                    <td><strong>{{ "%.2f"|format(row.rainfall) }}</strong></td>
                                    <td>
                                        <div class="rainfall-bar" style="width: {{ (row.rainfall / year_data['rainfall'].max() * 200)|int }}px;"></div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    {% endif %}
                </div>
            </div>

            
            <script>
                const ctx = document.getElementById('rainfallChart');
                if (ctx) {
                    const dates = [
                        {% for row in year_data.itertuples() %}
                            "{{ row.date.strftime('%d/%m') }}"{% if not loop.last %},{% endif %}
                        {% endfor %}
                    ];
                    const rainfallData = [
                        {% for row in year_data.itertuples() %}
                            {{ row.rainfall }}{% if not loop.last %},{% endif %}
                        {% endfor %}
                    ];

                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: dates,
                            datasets: [{
                                label: 'Lượng mưa (mm)',
                                data: rainfallData,
                                borderColor: '#4a90e2',
                                backgroundColor: 'rgba(74, 144, 226, 0.1)',
                                borderWidth: 2,
                                fill: true,
                                tension: 0.4,
                                pointRadius: 3,
                                pointHoverRadius: 6,
                                pointBackgroundColor: '#4a90e2',
                                pointBorderColor: '#fff',
                                pointBorderWidth: 2
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: true,
                                    labels: {
                                        color: '#f0f4f8',
                                        font: {
                                            family: 'Manrope',
                                            size: 12,
                                            weight: '600'
                                        }
                                    }
                                },
                                tooltip: {
                                    backgroundColor: 'rgba(26, 41, 66, 0.95)',
                                    titleColor: '#f0f4f8',
                                    bodyColor: '#e1e8ed',
                                    borderColor: '#4a90e2',
                                    borderWidth: 1,
                                    padding: 12,
                                    displayColors: true,
                                    titleFont: {
                                        family: 'Manrope',
                                        size: 14,
                                        weight: '700'
                                    },
                                    bodyFont: {
                                        family: 'Space Mono',
                                        size: 13
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    grid: {
                                        color: 'rgba(74, 144, 226, 0.1)'
                                    },
                                    ticks: {
                                        color: '#e1e8ed',
                                        font: {
                                            family: 'Space Mono',
                                            size: 11
                                        }
                                    }
                                },
                                x: {
                                    grid: {
                                        color: 'rgba(74, 144, 226, 0.05)'
                                    },
                                    ticks: {
                                        color: '#e1e8ed',
                                        font: {
                                            family: 'Space Mono',
                                            size: 10
                                        },
                                        maxRotation: 45,
                                        minRotation: 45
                                    }
                                }
                            }
                        }
                    });
                }
            </script>
        {% endif %}

        
        <div style="text-align: center; margin-top: var(--space-xl);">
            <a href="{{ url_for('main.predict') }}" class="btn btn-back">
                <i class="bi bi-arrow-left"></i>
                <span>Quay về trang dự đoán</span>
            </a>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
</body>
</html>
